<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Example SMART App</title>
        <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
        <style>
            #patient, #meds {
                font-family: Monaco, monospace;
                white-space: pre;
                font-size: 13px;
                height: 30vh;
                overflow: scroll;
                border: 1px solid #CCC;
                padding: 10px;
            }
            #obs {
                height: 40vh;
                overflow: auto;
                border: 1px solid #CCC;
            }
            table {
                width: 100%;
                border-collapse: collapse;
                font-size: 13px;
            }
            th {
                background-color: #f0f0f0;
                padding: 8px;
                text-align: left;
                border-bottom: 2px solid #ddd;
                position: sticky;
                top: 0;
            }
            td {
                padding: 8px;
                border-bottom: 1px solid #ddd;
            }
            tr:hover {
                background-color: #f5f5f5;
            }
            .category {
                display: inline-block;
                padding: 2px 8px;
                border-radius: 3px;
                font-size: 11px;
            }
            .vital-signs {
                background-color: #e3f2fd;
                color: #1976d2;
            }
            .laboratory {
                background-color: #fff3e0;
                color: #f57c00;
            }
            .survey {
                background-color: #f3e5f5;
                color: #7b1fa2;
            }
        </style>
    </head>
    <body>
        <h4>Current Patient</h4>
        <div id="patient">Loading...</div>
        <br/>
        <h4>Medications</h4>
        <div id="meds">Loading...</div>
        <br/>
        <h4>Observations</h4>
        <div id="obs">Loading...</div>
        <script type="text/javascript">
            FHIR.oauth2.ready().then(function(client) {
                
                // Render the current patient (or any error)
                client.patient.read().then(
                    function(pt) {
                        document.getElementById("patient").innerText = JSON.stringify(pt, null, 4);
                    },
                    function(error) {
                        document.getElementById("patient").innerText = error.stack;
                    }
                );
                
                // Get MedicationRequests for the selected patient
                client.request("/MedicationRequest?patient=" + client.patient.id, {
                    resolveReferences: [ "medicationReference" ],
                    graph: true
                })
                
                // Render the current patient's medications (or any error)
                .then(
                    function(data) {
                        if (!data.entry || !data.entry.length) {
                            document.getElementById("meds").innerText = "No medications found for the selected patient";
                        } else {
                            document.getElementById("meds").innerText = JSON.stringify(data.entry, null, 4);
                        }
                    },
                    function(error) {
                        document.getElementById("meds").innerText = error.stack;
                    }
                );

                // Get Observations for the selected patient
                client.request("/Observation?patient=" + client.patient.id + "&_sort=-date&_count=10", {
                    resolveReferences: ["performer"],
                    graph: false
                })
                
                // Render the current patient's observations (or any error)
                .then(
                    function(data) {
                        if (!data.entry || !data.entry.length) {
                            document.getElementById("obs").innerText = "No observations found for the selected patient";
                        } else {
                            // Create table for observations
                            var table = '<table><thead><tr><th>Date</th><th>Category</th><th>Type</th><th>Value</th></tr></thead><tbody>';
                            
                            data.entry.forEach(function(entry) {
                                var obs = entry.resource;
                                var date = obs.effectiveDateTime ? new Date(obs.effectiveDateTime).toLocaleDateString() : 'N/A';
                                var category = obs.category && obs.category[0] && obs.category[0].coding && obs.category[0].coding[0] ? obs.category[0].coding[0].code : 'N/A';
                                var type = obs.code.text || (obs.code.coding && obs.code.coding[0] ? obs.code.coding[0].display : 'N/A');
                                var value = '';
                                
                                // Handle different value types
                                if (obs.valueQuantity) {
                                    value = obs.valueQuantity.value.toFixed(2) + ' ' + obs.valueQuantity.unit;
                                } else if (obs.valueCodeableConcept) {
                                    value = obs.valueCodeableConcept.text || (obs.valueCodeableConcept.coding && obs.valueCodeableConcept.coding[0] ? obs.valueCodeableConcept.coding[0].display : 'N/A');
                                } else if (obs.component) {
                                    // Handle components (like Blood Pressure)
                                    value = obs.component.map(function(comp) {
                                        var compName = comp.code.text || (comp.code.coding && comp.code.coding[0] ? comp.code.coding[0].display : 'N/A');
                                        var compValue = comp.valueQuantity ? comp.valueQuantity.value.toFixed(2) + ' ' + comp.valueQuantity.unit : 'N/A';
                                        return compName + ': ' + compValue;
                                    }).join('<br>');
                                }
                                
                                table += '<tr><td>' + date + '</td><td><span class="category ' + category + '">' + category + '</span></td><td>' + type + '</td><td>' + value + '</td></tr>';
                            });
                            
                            table += '</tbody></table>';
                            document.getElementById("obs").innerHTML = table;
                        }
                    },
                    function(error) {
                        document.getElementById("obs").innerText = error.stack;
                    }
                );

            }).catch(console.error);
        </script>
    </body>
</html>
